trigger:
  branches:
    include:
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  # --- Make sure these values are correct ---
  AZURE_SERVICE_CONNECTION: 'AzureServiceConnection'
  AZURE_CONTAINER_REGISTRY: 'taskapiregistrycd123.azurecr.io' # Your ACR name
  WEB_APP_NAME: 'task-api-app-cd123' # Your App Service name
  # --- System Variables ---
  DOCKER_IMAGE_NAME: 'task-api'
  IMAGE_TAG: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildJob
    displayName: 'Build, Tag, and Push Image to ACR'
    steps:

    # This single task will handle everything: login, build, and push.
    # It uses the Azure CLI, which is the most reliable method.
    - task: AzureCLI@2
      displayName: 'Build and Push to ACR using Azure CLI'
      inputs:
        azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Use the 'az acr build' command to build and push the image in one step
          az acr build --registry $(AZURE_CONTAINER_REGISTRY) --image $(DOCKER_IMAGE_NAME):$(IMAGE_TAG) .

- stage: Deploy
  displayName: 'Deploy to App Service'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'master'))
  jobs:
  - deployment: DeployToWebApp
    displayName: 'Deploy Web App'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          # This task was already correct.
          - task: AzureWebAppContainer@1
            displayName: 'Deploy to Azure App Service'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              appName: '$(WEB_APP_NAME)'
              containers: '$(AZURE_CONTAINER_REGISTRY)/$(DOCKER_IMAGE_NAME):$(IMAGE_TAG)'